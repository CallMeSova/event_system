<?php
// ฟังก์ชันสร้างรหัส OTP 6 หลัก โดยไม่อาศัยการเก็บข้อมูลลง Database

function get_event_otp($reg_id, $create_date) {
    // 1. กำหนด "ช่วงเวลา" (Time Window)
    // เอาเวลาปัจจุบัน (วินาที) มาหารด้วย 1800 (30 นาที) แล้วปัดเศษทิ้ง
    // ผลลัพธ์คือ "เลขรอบ" ซึ่งจะเปลี่ยนทุกๆ 30 นาทีพอดีเป๊ะ
    $time_window = floor(time() / 1800);

    // 2. สร้าง "รหัสลับชั่วคราว" (Seed)
    // นำ ID, วันที่สมัคร และเลขรอบเวลา มาต่อกันเป็นข้อความเดียว
    // ข้อมูลนี้จะมีแค่ระบบและ User คนนั้นที่รู้กัน
    $seed = $reg_id . $create_date . $time_window;

    // 3. แปลงข้อความเป็นรหัส Hash (MD5)
    // เพื่อให้ได้ข้อความที่ดูมั่วซั่ว เดาทางไม่ได้
    $hash = md5($seed);

    // 4. สกัดเอาตัวเลข 6 หลักออกมา
    // ตัดเอา 8 ตัวแรกของ Hash มาแปลงจากฐาน 16 (hex) เป็นฐาน 10 (decimal)
    // แล้วใช้ % (Modulo) 1,000,000 เพื่อให้ได้ตัวเลขไม่เกิน 6 หลัก
    $otp_number = hexdec(substr($hash, 0, 8)) % 1000000;

    // 5. เติมเลข 0 ด้านหน้าถ้าเลขไม่ครบ 6 หลัก (เช่น 123 -> 000123)
    return str_pad($otp_number, 6, '0', STR_PAD_LEFT);
}
